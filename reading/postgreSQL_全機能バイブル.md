---
title: "postgreSQL全機能バイブル"
description:
date: 2023-11-12
draft: false
categories:
  - "reading"
tags:
  - "postgresql"
  - "database"
---

# トランザクション ID(XID)とは

Update は内部では Insert+Delete で処理する

トランザクションごとに XID を発行する。

XID は 3,4,5....N とふやしていく。最大値にたっすると 3 にもどる。

VACCUM 処理時に過去の XID をすべて 2 にするので、重複はない。

# プラン処理

## 前処理

1+1 みたいな内容を 2 にしたりする。

[PostgreSQL の実行計画について調べてみた | Casley Deep Innovations 株式会社 技術ブログ](https://www.casleydi.com/blog/engineer/259/)

## バッファマネージャ

共有メモリにデータを配置し、キャッシング的な利用をする。

その管理をおこなうのがバッファマネージャ。

ストレージにはバックグラウンドで書き込みをおこなう。

マネージャは三層で構成されている。

[BufferPool の実例を調べる - それが僕には楽しかったんです。](https://rabbitfoot141.hatenablog.com/entry/2019/12/10/000000)

### データのキャッシング

ディスクから読み込んだデータブロックをメモリ内のバッファプールにキャッシュする。

これにより、データベースのクエリがディスクに直接アクセスする必要が減り、パフォーマンスが向上する。

### バッファプールの管理

バッファプールは、データベースのメモリ内に設定されたサイズの空間。

バッファマネージャは、このバッファプール内のデータブロックを管理し、最適化する。

### データの書き込み

データが更新された場合、変更はまずバッファプール内のデータブロックに書き込まれる。

その後、バッファマネージャは、適切なタイミングでこれらの変更をディスクに書き戻す。

ストレージへのかきこみはバックグラウンドライタがバックグラウンドプロセスでおこなう。

### 置換アルゴリズム

バッファプールがいっぱいになった場合、バッファマネージャは置換アルゴリズムを使用して、どのデータブロックをメモリから削除するかを決定する。

昔は LRU をつかってたらしいが、8.2 から 9.4 までは ClockSweep という方式をつかっている。

[5.共有メモリとローカルヒープ - PostgreSQL Internals](https://www.postgresqlinternals.org/chapter5/)

### ディスク I/O の最適化

ディスク I/O の最適化がバッファマネージャのもう一つの重要な役割となる

これにより、ディスクへのアクセスを減らし、システム全体の効率を向上させる。
